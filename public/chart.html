<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chart</title>
    <style>

    </style>
    <script src="chart.min.js"></script>

    <script defer>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("load");
            loadData().then();
            //test();
        });

        async function loadData() {
            var dataset = { label: "село", data: [],
                radius: function(context) {
                    var index = context.dataIndex;
                    var data = context.dataset.data[index];
                    var size = context.chart.width;
                    var base = data.value / 100;
                    return (size / 24) * 10;
                },
                backgroundColor: '#ff3400'
            };

            var response = await fetch('resource/data.json');
            var regions = await response.json();

            var yLabels = {};
            var regId = 0
            for (let region in regions) {
                dataset.data.push( {
                    x: regions[region]['всего'],
                    y: regId,
                    r: Math.sqrt(regions[region]['село'])*0.8
                } );
                yLabels[regId++] = region;
            }

            const ctx = document.getElementById('chart');

            const opts = {
                scales: {
                    y: {
                        ticks: {
                            callback: function(value, index, ticks) {
                                return yLabels[value];
                            }
                        }
                    }
                },
                elements: {
                    point: {
                        radius: function(context) {
                            var index = context.dataIndex;
                            var data = context.dataset.data[index];
                            var size = context.chart.width;
                            var base = data.value / 100;
                            return (size / 24) * base;
                        }
                    }
                }
            };
            const config = {
                type: 'bubble',
                plugins: [{
                    afterDatasetUpdate: chart => {
                        chart.getDatasetMeta(0).data.forEach(v => {
                            v.options.radius = 30;
                            //v._options.hoverRadius = v._model.radius;
                        })
                    }
                }],
                data: { datasets: [dataset] },
                options: opts
            };

            new Chart(ctx, config);
        }

        function test() {
            const data = {
                datasets: [{
                    label: 'First Dataset',
                    radius: 100,
                    data: [{
                        x: 200,
                        y: 30,
                        r: 150
                    }, {
                        x: 4000,
                        y: 10,
                        r: 150
                    }],
                    backgroundColor: 'rgb(255, 99, 132)'
                }]
            };

            const config = {
                type: 'bubble',
                data: data,
                options: {}
            };

            var chartCanvas = document.getElementById('chart');
            new Chart(chartCanvas, config);
        }
    </script>
</head>
<body>
<div>
    <canvas id="chart"></canvas>
</div>
</body>
</html>